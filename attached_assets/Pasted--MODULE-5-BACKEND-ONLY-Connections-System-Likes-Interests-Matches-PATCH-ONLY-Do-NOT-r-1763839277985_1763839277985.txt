ğŸ§  MODULE 5 â€” BACKEND ONLY â€” Connections System (Likes, Interests, Matches)
âš ï¸ PATCH ONLY â€” Do NOT regenerate previous modules.
Do NOT install dependencies.
Do NOT run Prisma migrations in Replit.
Do NOT modify frontend.
ONLY create/update backend code.

ğŸ¯ Goal of Module 5

Implement the complete matchmaking interaction system:

âœ”ï¸ Send interest
âœ”ï¸ Withdraw interest
âœ”ï¸ Accept interest
âœ”ï¸ Decline interest
âœ”ï¸ Mutual match detection
âœ”ï¸ Retrieve lists:

Interests Sent

Interests Received

Mutual Matches

Shortlists (optional stub)

âœ”ï¸ Security rules:

Rate limit â†’ max 20 interest actions / day

Block validation (cannot like blocked users)

Cannot like yourself

One active interest per pair

Must have published profile

Must not like profiles hidden via privacy rules

âœ”ï¸ Idempotency:

Idempotency-Key header supported

Backend must gracefully handle duplicate requests

âœ”ï¸ Notification hooks:

Event stub: events.emit("interest.sent")

Event stub: events.emit("interest.accepted")
(No actual notification code â€” only stub)

ğŸ“ FILES TO CREATE/MODIFY
/backend/src/modules/connections/
  connections.routes.ts
  connections.controller.ts
  connections.service.ts
  connections.dto.ts
  interestRateLimit.service.ts
  idempotency.service.ts
  connections.test.ts        # test stubs only
  openapi.connections.yml

ğŸ§¬ PRISMA SCHEMA ADDITIONS

Append to schema:

model Interest {
  id            String   @id @default(uuid())
  fromUserId    String
  toUserId      String
  status        String   @default("pending") // pending | accepted | declined | withdrawn
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fromUser      User     @relation(fields: [fromUserId], references: [id])
  toUser        User     @relation(fields: [toUserId], references: [id])

  @@unique([fromUserId, toUserId])
}


Indexes (append):

@@index([fromUserId])
@@index([toUserId])

ğŸ”’ ENDPOINTS
1) POST /api/v1/connections/interest

Send interest to another user.

Body:

{ "toUserId": "..." }


Server logic:

Validate owner has published profile

Cannot send to yourself

Check block list (stub)

Check rate limit (20 per day)

If interest already exists:

If status=pending â†’ return existing

If status=declined/withdrawn â†’ update to pending

Create or update interest record

Trigger event stub

Respond { status: "pending" }

2) POST /api/v1/connections/interest/accept

Body:

{ "fromUserId": "..." }


Logic:

Check existence with status=pending

Update to accepted

Trigger events.emit("interest.accepted")

Detect mutual match

Respond { status: "accepted", isMatch: true/false }

3) POST /api/v1/connections/interest/decline

Same as accept â†’ status="declined"

4) POST /api/v1/connections/interest/withdraw

User withdraws their own sent interest.

Update â†’ status="withdrawn"

5) GET /api/v1/connections/interests/sent

List interests user has sent.

6) GET /api/v1/connections/interests/received

List interests user has received.

7) GET /api/v1/connections/matches

Return list where:

user sent â†’ accepted

user received â†’ accepted

This is a mutual match.

Use optimized Prisma query:

findMany where OR:
  [
    { fromUserId = me, status = "accepted" },
    { toUserId = me, status = "accepted" }
  ]


Then filter where the other user also accepted.

ğŸ”§ SUPPORT SERVICES
âœ”ï¸ interestRateLimit.service.ts

Store per-user count in Redis (stub in Replit):

Key: ratelimit:interest:{userId}:{YYYYMMDD}

Max: 20/day

Increment on every interest action

Reject with { error: "LIMIT_REACHED" }

âœ”ï¸ idempotency.service.ts

If request contains header:

Idempotency-Key: <uuid>


Store response hash in Redis for 10 minutes.
Return identical response on duplicate request.

âœ”ï¸ connections.dto.ts

Zod validation schemas.

ğŸ›¡ï¸ SECURITY RULES

All endpoints protected with JWT

Validate profile published=true

Respect block list (provide stub now)

Log every interaction with userId + IP

Idempotency enabled for all POST endpoints

429 on rate limit

Access control:

only receiver can accept/decline

only sender can withdraw

ğŸ“˜ OPENAPI

Create openapi.connections.yml:

All endpoints

Request/response schemas

Rate limit notes

Idempotency header documentation

ğŸ§ª TESTS (donâ€™t run)

Create test stubs for:

sending interest

accepting interest

mutual match detection

rate limit overflows

idempotency

invalid actions (self-like, duplicate like, blocked)

âœ”ï¸ RESPOND WITH

File tree

Contents of all new/changed files

Prisma additions

Tests (stubs)

OpenAPI docs

â€œNo installs or migrations executed.â€